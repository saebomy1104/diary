<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ°ì¼ê¸°ë•½ğŸ°</title>
    
    <!-- ì•„ì´ì½˜ & í°íŠ¸ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fonts-archive/Paperlogy/Paperlogy.css" type="text/css"/>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ìŠ¤íƒ€ì¼ ì„¤ì • -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#FF80AB',
                        'soft-pink': '#FFB7C5',
                        'bg-pink': '#FFF0F5',
                    },
                    fontFamily: {
                        'sans': ['Paperlogy', 'sans-serif'],
                        'hand': ['Paperlogy', 'sans-serif'],
                    },
                    animation: {
                        'bounce-slight': 'bounceSlight 2s infinite',
                        'pop-in': 'popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'float-heart': 'floatHeart 6s ease-in-out infinite',
                        'float-widget': 'floatWidget 4s ease-in-out infinite',
                        'rabbit-hop': 'rabbitHop 0.5s ease-in-out',
                    },
                    keyframes: {
                        bounceSlight: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        popIn: {
                            'from': { transform: 'scale(0.95)', opacity: '0' },
                            'to': { transform: 'scale(1)', opacity: '1' }
                        },
                        floatHeart: {
                            '0%, 100%': { transform: 'translateY(0) rotate(0deg)' },
                            '50%': { transform: 'translateY(-20px) rotate(10deg)' }
                        },
                        floatWidget: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' }
                        },
                        rabbitHop: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Paperlogy', sans-serif; user-select: none; }
        input, textarea { user-select: text !important; font-family: 'Paperlogy', sans-serif !important; }
        
        /* ë°°ê²½ ìº”ë²„ìŠ¤ */
        #sky-canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; 
            background: linear-gradient(to bottom, #ff9ebb 0%, #ffeaf4 100%); 
        }

        /* ë°°ê²½ íŒ¨í„´ */
        #bg-pattern {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            pointer-events: none; opacity: 0.15;
            background-image: radial-gradient(#ffffff 2px, transparent 2px), radial-gradient(#ffffff 2px, transparent 2px);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px; 
        }
        
        /* ìœˆë„ìš° ìŠ¤íƒ€ì¼ */
        .window-frame {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 1);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(255, 182, 193, 0.3);
            display: flex; flex-direction: column; overflow: hidden;
            transition: transform 0.1s, opacity 0.2s;
            animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .window-frame.active { 
            box-shadow: 0 25px 70px rgba(255, 105, 180, 0.25); 
            z-index: 100; 
            border: 2px solid #FFB7C5; 
        }
        .window-header { 
            padding: 10px 15px; 
            background: rgba(255, 240, 245, 0.95); 
            border-bottom: 1px solid #FFE4E1; 
            display: flex; justify-content: space-between; align-items: center; cursor: grab; 
        }
        .window-header:active { cursor: grabbing; }
        .window-content { flex: 1; overflow: auto; position: relative; }

        /* ë…ë°” */
        .dock-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px);
            border: 1px solid white; border-radius: 24px;
            padding: 10px 20px; display: flex; gap: 16px; z-index: 1000;
            box-shadow: 0 5px 20px rgba(255, 105, 180, 0.2);
        }
        .dock-item {
            width: 50px; height: 50px; border-radius: 14px; background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center; font-size: 24px; color: #FF80AB;
            cursor: pointer; transition: all 0.2s; position: relative;
        }
        .dock-item:hover { transform: translateY(-10px) scale(1.1); background: #FFF0F5; color: #FF69B4; }
        
        /* ìº˜ë¦°ë” ë“± ê³µí†µ ìŠ¤íƒ€ì¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day {
            min-height: 100px; padding: 6px; border-radius: 8px; cursor: pointer;
            background: white; border: 1px solid #FFF0F5; transition: all 0.2s;
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .calendar-day:hover { background: #FFF0F5; border-color: #FFB7C5; transform: scale(1.02); z-index: 10; shadow: md; }
        .calendar-day.today { border: 2px solid #FF69B4; background: #FFF5F8; }
        .calendar-day.today .day-num { background: #FF69B4; color: white; padding: 2px 6px; border-radius: 8px; display: inline-block; }
        
        .schedule-item { font-size: 11px; padding: 2px 4px; border-radius: 4px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .schedule-item.yearly { background-color: #FEF3C7; color: #D97706; border-left: 2px solid #F59E0B; }
        .schedule-item.monthly { background-color: #FCE7F3; color: #BE185D; border-left: 3px solid #FF69B4; }

        /* ì´ì–¼ë¦¬ ë·° ìŠ¤íƒ€ì¼ */
        .yearly-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .yearly-day { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border-radius: 4px; color: #666; }
        .yearly-day:hover { background-color: #FFF0F5; }
        .yearly-day.has-anniversary { background-color: #FF80AB; color: white; font-weight: bold; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* ë‹¤ì´ì–´ë¦¬ & ì•„ì´ì½˜ ì„ íƒê¸° */
        .icon-selector, .meta-selector { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .icon-option, .meta-icon {
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; cursor: pointer; border: 1px solid transparent; transition: all 0.2s;
            font-size: 18px; background: white;
        }
        .icon-option:hover, .meta-icon:hover { transform: scale(1.1); background: #FFF0F5; }
        .icon-option.selected, .meta-icon.selected { background: #FF80AB; color: white; border-color: #FF80AB; box-shadow: 0 2px 5px rgba(255, 128, 171, 0.4); }

        .picture-frame {
            width: 100%; aspect-ratio: 4/3; background: #f9fafb; border: 2px dashed #FFB7C5; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative;
        }
        .picture-frame:hover { background: #FFF0F5; border-color: #FF80AB; }
        .picture-frame img { width: 100%; height: 100%; object-fit: cover; }

        .lined-paper {
            background: repeating-linear-gradient(transparent, transparent 27px, #ffe4e1 28px);
            line-height: 28px; padding: 6px 10px; border: 1px solid #FFB7C5; border-radius: 8px; resize: none; outline: none;
        }

        /* ê·¸ë¦¼ì¼ê¸° ëª¨ì•„ë³´ê¸° */
        .photo-calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; padding: 10px;
        }
        .photo-calendar-day {
            aspect-ratio: 1/1; background: white; border-radius: 8px; overflow: hidden; position: relative;
            cursor: pointer; border: 1px solid #eee; transition: transform 0.2s;
        }
        .photo-calendar-day:hover { transform: scale(1.05); z-index: 10; border-color: #FF80AB; shadow: md; }
        .photo-calendar-day img { width: 100%; height: 100%; object-fit: cover; }
        .photo-calendar-day .day-num {
            position: absolute; top: 4px; left: 4px; font-size: 10px; font-weight: bold;
            background: rgba(255,255,255,0.8); padding: 2px 4px; border-radius: 4px; z-index: 2;
        }
        .no-img {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            background: #fdf2f8; color: #fbcfe8; font-size: 20px;
        }
        
        /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ */
        .custom-modal-overlay {
            position: fixed; inset: 0; background: rgba(255, 230, 240, 0.6); backdrop-filter: blur(2px); z-index: 9999;
            display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s;
        }
        .custom-modal-box {
            background: white; padding: 20px; border-radius: 20px; width: 340px;
            box-shadow: 0 10px 40px rgba(255, 105, 180, 0.2); border: 2px solid #FFB7C5;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* í•˜íŠ¸ ìœ„ì ¯ ìŠ¤íƒ€ì¼ */
        #heart-widget {
            position: absolute; 
            top: 15%; left: 10%; 
            width: 320px; height: 280px; 
            z-index: 5;
            animation: float-widget 4s ease-in-out infinite;
            cursor: grab;
            filter: drop-shadow(0 10px 15px rgba(255, 105, 180, 0.2));
        }
        #heart-memo {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 65%; height: 50%; 
            background: transparent; border: none; resize: none;
            outline: none; text-align: center; font-family: 'Paperlogy', sans-serif;
            font-size: 20px; 
            font-weight: 500; 
            color: #ff6b8b; 
            z-index: 10;
        }
        #heart-memo::placeholder { color: #ffb7c5; }

        /* í´ë¼ë¡œì´ë“œ ìŠ¤íƒ€ì¼ */
        #polaroid-widget {
            position: absolute; 
            bottom: 20%; right: 5%; 
            width: 220px;
            background: white; padding: 12px 12px 35px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transform: rotate(-3deg); transition: transform 0.3s; cursor: pointer; z-index: 5;
        }
        #polaroid-widget:hover { transform: rotate(0deg) scale(1.05) translateY(-5px); z-index: 20; box-shadow: 0 15px 40px rgba(255, 105, 180, 0.3); }
        #polaroid-widget::before { 
            content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 80px; height: 25px; background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transform: translateX(-50%) rotate(2deg);
        }
        /* ì‚¬ì§„ ë³€ê²½ ì•ˆë‚´ ì˜¤ë²„ë ˆì´ */
        .polaroid-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.2); 
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; border-radius: 4px;
        }
        #polaroid-widget:hover .polaroid-overlay { opacity: 1; }

        .polaroid-caption { 
            font-family: 'Paperlogy', sans-serif; text-align: center; margin-top: 15px; 
            color: #666; outline: none; border: none; background: transparent; width: 100%;
            font-size: 16px; border-bottom: 1px solid transparent; font-weight: bold;
        }
        .polaroid-caption:focus { border-bottom: 1px dashed #FFB7C5; background: #fff0f5; }

        /* í† ë¼ í« ìŠ¤íƒ€ì¼ - ìœ„ì¹˜ ê³ ì • */
        #desktop-pet {
            position: absolute; bottom: 100px; left: 100px; width: 60px; height: 60px; z-index: 10;
            cursor: pointer; transition: transform 0.2s;
        }
        #desktop-pet:active { transform: scale(0.9); }
        .pet-body { font-size: 50px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }
        .pet-heart { 
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%); 
            font-size: 24px; opacity: 0; transition: opacity 0.5s, transform 0.5s; pointer-events: none;
        }
        .pet-heart.show { opacity: 1; transform: translateX(-50%) translateY(-20px); }
        .pet-speech {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: white; border: 2px solid #FFB7C5; border-radius: 12px;
            padding: 6px 10px; font-size: 11px; color: #FF69B4; font-weight: bold;
            white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.3s, transform 0.3s;
            margin-bottom: 10px; box-shadow: 0 2px 10px rgba(255,182,193,0.3); z-index: 20;
        }
        .pet-speech::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            border-width: 5px 5px 0; border-style: solid; border-color: #FFB7C5 transparent transparent transparent;
        }
        .pet-speech.show { opacity: 1; transform: translateX(-50%) translateY(-5px); }

        /* íƒ€ë¡œ ì¹´ë“œ ë“± ê¸°íƒ€ ìŠ¤íƒ€ì¼ ìƒëµ (ê¸°ì¡´ ìœ ì§€) */
        .tarot-card { width: 180px; height: 280px; perspective: 1000px; cursor: pointer; }
        .tarot-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
        .tarot-card.flipped .tarot-inner { transform: rotateY(180deg); }
        .tarot-front, .tarot-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 15px; border: 3px solid #FFB7C5; box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .tarot-front { background: white; transform: rotateY(180deg); padding: 15px; }
        .tarot-back { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); }
        .tarot-back::after { content: 'ğŸ”®'; font-size: 50px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 183, 197, 0.5); border-radius: 3px; }
        
        /* ë¡œê·¸ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .login-btn {
            background: white; color: #757575; font-weight: bold; font-family: 'Paperlogy', sans-serif;
            padding: 10px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;
            border: 1px solid #ddd;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    </style>
</head>
<body class="text-slate-700 selection:bg-pink-200 selection:text-white">

    <!-- ë¡œë”© & ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loading-screen" class="fixed inset-0 z-[9999] bg-[#FFB7C5] flex flex-col items-center justify-center transition-opacity duration-700">
        <i class="fas fa-heart text-6xl text-white animate-bounce mb-4"></i>
        <!-- [ìˆ˜ì •] ë¡œê·¸ì¸ íƒ€ì´í‹€ ë³€ê²½: Sky Mini-Hompy -> ìƒˆë´„ì´ë„¤ -->
        <h1 class="text-3xl font-bold text-white tracking-widest font-sans mb-6">ìƒˆë´„ì´ë„¤</h1>
        <p id="loading-text" class="text-white/90 mb-6">ìƒˆë´„ì´ë„¤ ì—°ê²° ì¤‘... â˜ï¸</p>
        
        <!-- êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ (ì²˜ìŒì—” ìˆ¨ê¹€) -->
        <button id="google-login-btn" class="hidden login-btn" onclick="DB.login()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
            <span>Googleë¡œ ë¡œê·¸ì¸í•˜ê³  ì‹œì‘í•˜ê¸°</span>
        </button>
    </div>

    <!-- ë°°ê²½ -->
    <div id="bg-pattern"></div>
    <canvas id="sky-canvas"></canvas>
    <canvas id="cursor-canvas"></canvas>

    <!-- í•˜íŠ¸ ë©”ëª¨ ìœ„ì ¯ (placeholder ì œê±°) -->
    <div id="heart-widget">
        <!-- SVG í•˜íŠ¸ ë°°ê²½ (í°ìƒ‰) -->
        <svg class="absolute inset-0 w-full h-full text-white drop-shadow-xl" viewBox="0 0 24 24" fill="currentColor" opacity="0.95">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
        <textarea id="heart-memo" placeholder="" oninput="HeartWidget.save(this.value)"></textarea>
    </div>

    <!-- í´ë¼ë¡œì´ë“œ ìœ„ì ¯ (ì§ì ‘ ë³€ê²½ ê¸°ëŠ¥ ì¶”ê°€) -->
    <!-- [ìˆ˜ì •] onclick="PolaroidApp.refresh()" ì œê±°í•˜ì—¬ í´ë¦­ ì¶©ëŒ ë°©ì§€ -->
    <div id="polaroid-widget">
        <!-- JSë¡œ ë‚´ìš© ì±„ì›€ -->
    </div>

    <!-- í† ë¼ í« (ìœ„ì¹˜ ê³ ì •) -->
    <div id="desktop-pet" onclick="RabbitPet.hop()">
        <div class="pet-speech">ì•ˆë…•? ë‚œ í† ë¼ì•¼! ğŸ°</div>
        <div class="pet-body">ğŸ°</div>
        <div class="pet-heart">ğŸ°</div>
    </div>

    <!-- ì•„ì´ì½˜ -->
    <div class="absolute top-8 left-8 flex flex-col gap-6 z-10">
        <div class="group flex flex-col items-center gap-2 cursor-pointer hover:scale-105 transition" onclick="app.openWindow('profile')">
            <div class="w-16 h-16 bg-white/40 backdrop-blur rounded-2xl flex items-center justify-center border border-white/60 shadow-lg group-hover:bg-white/70">
                <i class="fas fa-user-astronaut text-3xl text-pink-500"></i>
            </div>
            <span class="text-white font-bold drop-shadow-md text-sm bg-pink-400/50 px-2 rounded">ë‚´ í”„ë¡œí•„</span>
        </div>
        
        <div class="group flex flex-col items-center gap-2 cursor-pointer hover:scale-105 transition" onclick="app.openWindow('fortune')">
            <div class="w-16 h-16 bg-white/40 backdrop-blur rounded-2xl flex items-center justify-center border border-white/60 shadow-lg group-hover:bg-white/70">
                <i class="fas fa-clover text-3xl text-green-400"></i>
            </div>
            <span class="text-white font-bold drop-shadow-md text-sm bg-pink-400/50 px-2 rounded">ì˜¤ëŠ˜ì˜ ìš´ì„¸</span>
        </div>

        <div class="group flex flex-col items-center gap-2 cursor-pointer hover:scale-105 transition" onclick="app.openWindow('diary_viewer')">
             <div class="w-16 h-16 bg-white/40 backdrop-blur rounded-2xl flex items-center justify-center border border-white/60 shadow-lg group-hover:bg-white/70">
                <i class="fas fa-book-open text-3xl text-pink-500"></i>
            </div>
            <span class="text-white font-bold drop-shadow-md text-sm bg-pink-400/50 px-2 rounded">ê·¸ë¦¼ì¼ê¸°</span>
        </div>

        <!-- íƒ€ì„ìº¡ìŠ -->
        <div class="group flex flex-col items-center gap-2 cursor-pointer hover:scale-105 transition" onclick="app.openWindow('time_capsule')">
             <div class="w-16 h-16 bg-white/40 backdrop-blur rounded-2xl flex items-center justify-center border border-white/60 shadow-lg group-hover:bg-white/70">
                <i class="fas fa-hourglass-half text-3xl text-orange-400"></i>
            </div>
            <span class="text-white font-bold drop-shadow-md text-sm bg-pink-400/50 px-2 rounded">íƒ€ì„ìº¡ìŠ</span>
        </div>
    </div>

    <!-- ìš°ì¸¡ ìƒë‹¨ ìœ„ì ¯ -->
    <!-- [ìˆ˜ì •] z-index 50 -> 10ìœ¼ë¡œ í•˜í–¥ ì¡°ì • (ìœˆë„ìš° ë’¤ë¡œ ê°€ë„ë¡) -->
    <div class="absolute top-8 right-8 text-right text-white select-none pointer-events-none flex flex-col items-end gap-2 z-10">
        <div>
            <h1 id="clock-time" class="text-6xl font-bold tracking-tight text-white drop-shadow-sm font-sans">12:00</h1>
            <p id="clock-date" class="text-lg opacity-90 font-bold">2025ë…„ 12ì›” 3ì¼ ìˆ˜ìš”ì¼</p>
        </div>
        <div class="flex items-center gap-2 bg-white/30 backdrop-blur px-3 py-1 rounded-full border border-white/50">
            <i id="weather-icon" class="fas fa-sun text-yellow-300"></i>
            <span id="weather-text" class="text-sm font-bold text-white">ë§‘ìŒ 24Â°C</span>
        </div>
        <div id="dday-widget" class="flex items-center gap-3 bg-white/40 backdrop-blur px-4 py-2 rounded-xl border border-white/50 shadow-lg animate-bounce-slight mt-2 pointer-events-auto cursor-pointer hover:scale-105 transition" onclick="DDayApp.openSettings()">
            <!-- JS -->
        </div>
        <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ì‘ê²Œ) -->
        <button onclick="DB.logout()" class="mt-2 text-xs text-white/70 hover:text-white underline pointer-events-auto cursor-pointer">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ìœˆë„ìš° ì»¨í…Œì´ë„ˆ -->
    <div id="window-container" class="absolute inset-0 pointer-events-none z-20"></div>

    <!-- ë…ë°” -->
    <div class="dock-container z-30">
        <div class="dock-item" onclick="app.openWindow('planner')"><i class="fas fa-calendar-alt text-red-400"></i></div>
        <div class="dock-item" onclick="app.openWindow('notepad')"><i class="fas fa-sticky-note text-yellow-500"></i></div>
        <div class="dock-item" onclick="app.openWindow('todo')"><i class="fas fa-check-square text-green-500"></i></div>
        <div class="dock-item" onclick="app.openWindow('gallery')"><i class="fas fa-camera text-blue-400"></i></div>
    </div>

    <!-- ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ -->
    <div id="modal-container" class="relative z-[9999]"></div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- 0. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (Firebase) ---
        
        let firebaseConfig;
        let appId = 'saeboms-pink-world'; // ê¸°ë³¸ ì•± ID

        // Gemini ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ì¸ì§€ í™•ì¸
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') appId = __app_id;
        } else {
            // ğŸ”¥ [ê¹ƒí—ˆë¸Œ ë°°í¬ìš©] ìƒˆë´„ì´ì˜ íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •
            firebaseConfig = {
              apiKey: "AIzaSyCWxYsElTcy7X4b7J18IbZOHXSAVg9vIDY",
              authDomain: "diary-80a65.firebaseapp.com",
              projectId: "diary-80a65",
              storageBucket: "diary-80a65.firebasestorage.app",
              messagingSenderId: "1012838308810",
              appId: "1:1012838308810:web:e3ef40d64a16416e490d33"
            };
        }

        let appInstance, auth, db, user;
        const googleProvider = new GoogleAuthProvider();
        
        // ë°ì´í„° ìºì‹± (ì†ë„ í–¥ìƒìš©)
        const Cache = {
            data: {},
            isLoaded: false
        };

        const DB = {
            // ì´ˆê¸°í™”: íŒŒì´ì–´ë² ì´ìŠ¤ ì—°ê²° ë° ì¸ì¦ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            init: async () => {
                if (!firebaseConfig) {
                    Cache.isLoaded = true;
                    // ì„¤ì •ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í™”ë©´ì„ ìˆ¨ê¸°ê³  ë¡œì»¬ ëª¨ë“œì²˜ëŸ¼ ë™ì‘í•˜ê²Œ í•  ìˆ˜ë„ ìˆì§€ë§Œ,
                    // ì‚¬ìš©ìì—ê²Œ ì„¤ì •ì„ ìœ ë„í•˜ê¸° ìœ„í•´ ê²½ê³ ë§Œ ë‚¨ê¹€
                    document.getElementById('loading-text').innerText = "Firebase ì„¤ì •ì´ í•„ìš”í•´ìš”!";
                    return;
                }

                try {
                    appInstance = initializeApp(firebaseConfig);
                    auth = getAuth(appInstance);
                    db = getFirestore(appInstance);

                    // 1. Gemini ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ ì „ìš©: ìë™ ë¡œê·¸ì¸
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } 
                    // 2. ê¹ƒí—ˆë¸Œ ë°°í¬ í™˜ê²½: ìë™ ë¡œê·¸ì¸ ì‹œë„ ì•ˆ í•¨ (ì‚¬ìš©ìê°€ ë²„íŠ¼ ëˆŒëŸ¬ì•¼ í•¨)
                    // ë‹¤ë§Œ, ì´ì „ì— ë¡œê·¸ì¸í•œ ê¸°ë¡ì´ ìˆìœ¼ë©´ onAuthStateChangedê°€ ìë™ìœ¼ë¡œ ê°ì§€í•¨!

                    // ì¸ì¦ ìƒíƒœ ë³€í™” ê°ì§€
                    onAuthStateChanged(auth, async (u) => {
                        if (u) {
                            user = u;
                            console.log("ë¡œê·¸ì¸ ì„±ê³µ:", user.uid);
                            await DB.loadAllData(); // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                            
                            // ë¡œë”© í™”ë©´ ì œê±° & ì•± ì‹œì‘
                            document.getElementById('loading-screen').style.opacity = '0'; 
                            setTimeout(()=>document.getElementById('loading-screen').remove(),700);
                        } else {
                            // ë¡œê·¸ì•„ì›ƒ ìƒíƒœë©´ ë¡œê·¸ì¸ ë²„íŠ¼ ë³´ì—¬ì£¼ê¸°
                            document.getElementById('loading-text').innerText = "ë¡œê·¸ì¸ì´ í•„ìš”í•´ìš”!";
                            document.getElementById('google-login-btn').classList.remove('hidden');
                        }
                    });

                } catch (e) {
                    console.error("Firebase ì—°ê²° ì‹¤íŒ¨:", e);
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }
            },

            // êµ¬ê¸€ ë¡œê·¸ì¸ í•¨ìˆ˜
            login: async () => {
                try {
                    await signInWithPopup(auth, googleProvider);
                } catch (error) {
                    console.error("Login failed", error);
                    alert("ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš” ğŸ˜¢ íŒì—… ì°¨ë‹¨ì´ ë˜ì–´ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!");
                }
            },

            // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ (ì»¤ìŠ¤í…€ ëª¨ë‹¬)
            logout: () => {
                const modal = document.createElement('div');
                modal.className = 'custom-modal-overlay';
                modal.innerHTML = `
                    <div class="custom-modal-box">
                        <h3 class="text-lg font-bold mb-3 text-pink-500 text-center">ë¡œê·¸ì•„ì›ƒ</h3>
                        <p class="text-sm text-gray-600 text-center mb-4">ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ì–´ìš”?</p>
                        <div class="flex justify-center gap-3">
                            <button onclick="this.closest('.custom-modal-overlay').remove()" class="px-4 py-2 rounded text-gray-500 bg-gray-100 hover:bg-gray-200">ì·¨ì†Œ</button>
                            <button onclick="DB.confirmLogout()" class="px-4 py-2 rounded bg-pink-400 text-white font-bold hover:bg-pink-500">í™•ì¸</button>
                        </div>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
            },

            confirmLogout: async () => {
                try {
                    await signOut(auth);
                    window.location.reload();
                } catch (e) {
                    console.error("Logout failed", e);
                    alert("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            },

            // ëª¨ë“  ë°ì´í„° í•œ ë²ˆì— ë¶ˆëŸ¬ì˜¤ê¸°
            loadAllData: async () => {
                const collections = ['heart_memo', 'my_dday', 'polaroid_data', 'time_capsule', 'profile_data_v2', 'planner_diary_v2', 'planner_schedule', 'planner_yearly', 'planner_weekly_todo', 'memos', 'todos', 'imgs'];
                
                for (const col of collections) {
                    let docRef;
                    if (typeof __app_id !== 'undefined') {
                            docRef = doc(db, 'artifacts', appId, 'users', user.uid, col, 'data');
                    } else {
                            // ê°œì¸ ê¹ƒí—ˆë¸Œìš© ë‹¨ìˆœ ê²½ë¡œ
                            docRef = doc(db, 'users', user.uid, 'app_data', col);
                    }
                    
                    const snapshot = await getDoc(docRef);
                    if (snapshot.exists()) {
                        Cache.data[col] = snapshot.data().val;
                    }
                }
                Cache.isLoaded = true;
            },

            // ì €ì¥ (ë¡œì»¬ + íŒŒì´ì–´ë² ì´ìŠ¤ ë™ê¸°í™”)
            save: async (key, data) => {
                Cache.data[key] = data; 
                if (db && user) {
                    try {
                        let docRef;
                        if (typeof __app_id !== 'undefined') {
                             docRef = doc(db, 'artifacts', appId, 'users', user.uid, key, 'data');
                        } else {
                             docRef = doc(db, 'users', user.uid, 'app_data', key);
                        }
                        await setDoc(docRef, { val: data }, { merge: true });
                    } catch (e) { console.error("ì €ì¥ ì‹¤íŒ¨:", e); }
                } else {
                    localStorage.setItem(`skyos_bk_${key}`, JSON.stringify(data));
                }
            },

            // ë¶ˆëŸ¬ì˜¤ê¸° (ìºì‹œì—ì„œ ì¦‰ì‹œ ë¦¬í„´)
            load: (key, defaultVal) => {
                if (Cache.data[key] !== undefined) return Cache.data[key];
                try {
                    const local = localStorage.getItem(`skyos_bk_${key}`);
                    if (local) return JSON.parse(local);
                } catch(e) {}
                return defaultVal;
            }
        };

        // --- Utils ë“± ê¸°ì¡´ ë¡œì§ ---
        const Utils = {
            formatDate: () => new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }),
            formatTime: () => new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
            calculateDDay: (dateStr) => Math.floor((new Date() - new Date(dateStr)) / (86400000)) + 1,
            readFile: (f, cb) => { const r = new FileReader(); r.onload = e => cb(e.target.result); r.readAsDataURL(f); }
        };

        // --- 1. ë§ˆìš°ìŠ¤ íŠ¸ë ˆì¼ ---
        class MouseTrail {
            constructor() {
                this.cvs = document.getElementById('cursor-canvas'); this.ctx = this.cvs.getContext('2d'); this.particles = [];
                this.resize(); window.addEventListener('resize', () => this.resize());
                window.addEventListener('mousemove', (e) => this.add(e.clientX, e.clientY)); this.loop();
            }
            resize() { this.w = this.cvs.width = window.innerWidth; this.h = this.cvs.height = window.innerHeight; }
            add(x, y) { this.particles.push({x, y, size: Math.random()*10+5, life: 1, vX: Math.random()-0.5, vY: Math.random()-0.5}); }
            drawHeart(x, y, size, alpha) {
                const ctx = this.ctx; ctx.globalAlpha = alpha; ctx.fillStyle = "#FFFFFF"; ctx.beginPath(); ctx.translate(x, y); ctx.scale(size/10, size/10);
                ctx.moveTo(0, 0); ctx.bezierCurveTo(-5, -5, -10, 2.5, 0, 10); ctx.bezierCurveTo(10, 2.5, 5, -5, 0, 0); ctx.fill(); ctx.setTransform(1, 0, 0, 1, 0, 0); ctx.globalAlpha = 1;
            }
            loop() {
                this.ctx.clearRect(0, 0, this.w, this.h);
                this.particles.forEach((p, i) => { p.x += p.vX; p.y += p.vY + 0.5; p.life -= 0.03; if(p.life <= 0) this.particles.splice(i, 1); else this.drawHeart(p.x, p.y, p.size, p.life); });
                requestAnimationFrame(() => this.loop());
            }
        }

        // --- 2. ìŠ¤ì¹´ì´ ë Œë”ëŸ¬ (ë°°ê²½ ê·¸ë¼ë°ì´ì…˜) ---
        class SkyRenderer {
            constructor() {
                this.cvs = document.getElementById('sky-canvas'); this.ctx = this.cvs.getContext('2d'); this.items = [];
                this.resize(); window.addEventListener('resize', () => this.resize());
                for(let i=0; i<15; i++) this.items.push({x: Math.random()*this.w, y: Math.random()*this.h, s: Math.random()*0.8+0.3, v: Math.random()*0.3+0.1});
                this.loop();
            }
            resize() { this.w = this.cvs.width = window.innerWidth; this.h = this.cvs.height = window.innerHeight; }
            drawHeart(ctx, x, y, size) {
                ctx.save(); ctx.translate(x, y); ctx.scale(size, size); ctx.beginPath();
                ctx.moveTo(0, 0); ctx.bezierCurveTo(-10, -10, -20, 5, 0, 20); ctx.bezierCurveTo(20, 5, 10, -10, 0, 0); ctx.fill(); ctx.restore();
            }
            loop() {
                const g = this.ctx.createLinearGradient(0,0,0,this.h);
                // [ìˆ˜ì •] ë©”ì¸ ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ ë°˜ì „: ìœ„(ì§„í•œ í•‘í¬) -> ì•„ë˜(ì—°í•œ í•‘í¬)
                g.addColorStop(0,'#ff9ebb'); // Top: ì¡°ê¸ˆ ì§„í•œ ì¿¨í†¤ í•‘í¬
                g.addColorStop(1,'#ffeaf4'); // Bottom: ì•„ì£¼ ë°ì€ ì¿¨í†¤ í•‘í¬
                this.ctx.fillStyle = g; this.ctx.fillRect(0,0,this.w,this.h);
                this.items.forEach(c => {
                    c.y -= c.v; 
                    // FIX: í•˜íŠ¸ê°€ í™”ë©´ ìœ„ë¡œ ì˜¬ë¼ê°€ë©´ ìœ„ì¹˜ë¥¼ ë‹¤ì‹œ ëœë¤í•˜ê²Œ ì„ì–´ì¤ë‹ˆë‹¤
                    if(c.y < -50) {
                        c.y = this.h + 50;
                        c.x = Math.random() * this.w;
                    }
                    this.ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    this.drawHeart(this.ctx, c.x, c.y, c.s);
                });
                requestAnimationFrame(() => this.loop());
            }
        }

        // --- 3. ìœˆë„ìš° ê´€ë¦¬ì ---
        class WindowManager {
            constructor() { this.el = document.getElementById('window-container'); this.z = 100; this.wins = {}; }
            create(id, title, content, w, h) {
                if(this.wins[id]) { this.front(id); return; }
                const div = document.createElement('div'); div.className = 'window-frame pointer-events-auto'; div.id = `win-${id}`;
                const left = Math.max(20, Math.min(window.innerWidth - w - 20, Math.random() * (window.innerWidth - w)));
                const top = Math.max(20, Math.min(window.innerHeight - h - 60, Math.random() * (window.innerHeight - h)));
                div.style.cssText = `width:${w}px; height:${h}px; left:${left}px; top:${top}px; z-index:${++this.z}`;
                div.innerHTML = `<div class="window-header"><div class="flex gap-2"><div class="w-3 h-3 rounded-full bg-red-400 cursor-pointer hover:scale-110" onclick="app.close('${id}')"></div><div class="w-3 h-3 rounded-full bg-yellow-400"></div><div class="w-3 h-3 rounded-full bg-green-400 cursor-pointer hover:scale-110" onclick="app.max('${id}')"></div></div><span class="font-bold text-gray-600 text-sm">${title}</span><div class="w-4"></div></div><div class="window-content">${content}</div>`;
                this.el.appendChild(div); this.wins[id] = div; this.drag(div, id); div.onmousedown = () => this.front(id);
            }
            close(id) { if(this.wins[id]) { this.wins[id].remove(); delete this.wins[id]; } }
            front(id) { if(this.wins[id]) { this.wins[id].style.zIndex = ++this.z; document.querySelectorAll('.window-frame').forEach(e=>e.classList.remove('active')); this.wins[id].classList.add('active'); } }
            max(id) { const w = this.wins[id]; if(w.dataset.m) { w.style=w.dataset.o; delete w.dataset.m; } else { w.dataset.o=w.style.cssText; w.style.cssText=`width:100%;height:calc(100% - 90px);top:0;left:0;z-index:${++this.z}`; w.dataset.m=1; } }
            drag(el, id) { const h = el.querySelector('.window-header'); let x, y; h.onmousedown = e => { x=e.clientX; y=e.clientY; document.onmousemove = drag; document.onmouseup = stop; this.front(id); }; const drag = e => { el.style.top = (el.offsetTop - (y - e.clientY)) + "px"; el.style.left = (el.offsetLeft - (x - e.clientX)) + "px"; x=e.clientX; y=e.clientY; }; const stop = () => { document.onmousemove = null; document.onmouseup = null; }; }
        }

        // --- 4. Widget Logics ---
        
        // Heart Widget (ë©”ëª¨ì¥)
        const HeartWidget = {
            init: () => {
                const memo = DB.load('heart_memo', ''); 
                const el = document.getElementById('heart-memo');
                if(el) el.value = memo;
            },
            save: (val) => {
                DB.save('heart_memo', val);
            }
        };

        // Rabbit Pet
        const RabbitPet = {
            el: null, heart: null, isMoving: false,
            messages: ["ìƒˆë´„ì•„ ëˆˆ ê¹œë¹¡ì—¬ë´! ğŸ‘€", "ìœ¼ìŒ°ìœ¼ìŒ° ìŠ¤íŠ¸ë ˆì¹­! ğŸ™†â€â™€ï¸", "ì‚¬ë‘í•´! ğŸ’–", "ì˜¤ëŠ˜ ê¸°ë¶„ ì–´ë•Œ? ğŸ°", "ë¬¼ ë§ˆì…¨ì–´? ğŸ’§", "ê±°ë¶ëª© ì¡°ì‹¬! ğŸ¢", "ì›ƒì–´ë´ ìŠ¤ë§ˆì¼ âœ¨", "ë‹¨ ê±° ë¨¹ì„ë˜? ğŸ°", "ë„Œ ìµœê³ ì•¼! ğŸ‘"],
            init: () => {
                RabbitPet.el = document.getElementById('desktop-pet');
                RabbitPet.heart = document.querySelector('.pet-heart');
                // RabbitPet.moveLoop(); // ì›€ì§ì„ ë£¨í”„ ì œê±°
                RabbitPet.talkLoop();
            },
            hop: () => {
                if(RabbitPet.isMoving) return;
                RabbitPet.el.classList.add('animate-rabbit-hop');
                RabbitPet.heart.classList.add('show');
                RabbitPet.talk();
                setTimeout(() => { RabbitPet.el.classList.remove('animate-rabbit-hop'); RabbitPet.heart.classList.remove('show'); }, 1000);
            },
            talk: () => {
                const msg = RabbitPet.messages[Math.floor(Math.random() * RabbitPet.messages.length)];
                const bubble = document.querySelector('.pet-speech');
                bubble.innerText = msg; bubble.classList.add('show'); setTimeout(() => bubble.classList.remove('show'), 3000);
            },
            talkLoop: () => { setTimeout(() => { RabbitPet.talk(); RabbitPet.talkLoop(); }, Math.random() * 5000 + 8000); },
            moveLoop: () => {
                if(Math.random() > 0.7) { 
                    const x = Math.random() * (window.innerWidth - 100);
                    RabbitPet.el.style.transform = `translateX(${x}px) scaleX(${Math.random() > 0.5 ? 1 : -1})`; 
                    RabbitPet.el.style.left = '0px'; RabbitPet.el.style.transition = "all 2s ease-in-out"; RabbitPet.el.style.left = x + "px"; RabbitPet.el.style.transform = "none"; 
                } setTimeout(RabbitPet.moveLoop, 3000);
            }
        };

        // D-Day App
        const DDayApp = {
            data: {},
            init: () => {
                // [ìˆ˜ì •] ê¸°ë³¸ ì œëª© ë³€ê²½: 'ê±´ìš©ì´ë‘ ì‚¬ë‘í•œì§€' -> 'ì œëª©'
                DDayApp.data = DB.load('my_dday', { date: '2022-10-01', name: 'ì œëª©', icon1: 'ğŸ¤´', icon2: 'ğŸ‘¸' });
                DDayApp.render();
            },
            render: () => { const days = Utils.calculateDDay(DDayApp.data.date); document.getElementById('dday-widget').innerHTML = `<div class="flex -space-x-2 text-lg"><span>${DDayApp.data.icon1}</span><span>${DDayApp.data.icon2}</span></div><div><p class="text-[10px] text-white font-bold">${DDayApp.data.name}</p><p class="text-lg font-extrabold text-white drop-shadow-sm font-sans">D + ${days}ì¼ ğŸ’•</p></div>`; },
            openSettings: () => {
                const modal = document.createElement('div'); modal.className = 'custom-modal-overlay'; modal.onmousedown = (e) => e.stopPropagation();
                modal.innerHTML = `<div class="custom-modal-box"><h3 class="text-lg font-bold mb-3 text-pink-500">D-Day ì„¤ì •</h3><div class="space-y-3"><div><label class="text-xs text-gray-500">ì œëª©</label><input id="dd-name" class="w-full border p-1 rounded" value="${DDayApp.data.name}"></div><div><label class="text-xs text-gray-500">ë‚ ì§œ</label><input id="dd-date" type="date" class="w-full border p-1 rounded" value="${DDayApp.data.date}"></div><div class="flex gap-2"><div class="flex-1"><label class="text-xs text-gray-500">ì•„ì´ì½˜ 1</label><input id="dd-icon1" class="w-full border p-1 rounded text-center" value="${DDayApp.data.icon1}"></div><div class="flex-1"><label class="text-xs text-gray-500">ì•„ì´ì½˜ 2</label><input id="dd-icon2" class="w-full border p-1 rounded text-center" value="${DDayApp.data.icon2}"></div></div></div><div class="flex justify-end gap-2 mt-4"><button onclick="this.closest('.custom-modal-overlay').remove()" class="px-3 py-1 rounded text-gray-500 bg-gray-100">ì·¨ì†Œ</button><button onclick="DDayApp.save()" class="px-3 py-1 rounded bg-pink-400 text-white font-bold">ì €ì¥</button></div></div>`;
                document.getElementById('modal-container').appendChild(modal);
            },
            save: () => { DDayApp.data.name = document.getElementById('dd-name').value; DDayApp.data.date = document.getElementById('dd-date').value; DDayApp.data.icon1 = document.getElementById('dd-icon1').value; DDayApp.data.icon2 = document.getElementById('dd-icon2').value; DB.save('my_dday', DDayApp.data); DDayApp.render(); document.querySelector('.custom-modal-overlay').remove(); }
        };

        // Fortune App
        const FortuneApp = {
            fortunes: ["ì˜¤ëŠ˜ì€ ë­˜ í•´ë„ ë˜ëŠ” ë‚ ! ğŸ«", "ê¸¸ ê°€ë‹¤ ëˆ ì¤ëŠ” í–‰ìš´?! ğŸ‘€", "ì¸ìƒìƒ· ê±´ì§€ëŠ” ë‚ ! ğŸ“¸", "ëœ»ë°–ì˜ ì„ ë¬¼ ë„ì°© ğŸ", "ë¨¹ê³  ì‹¶ë˜ ê±° ë¨¹ëŠ” ë‚  ğŸ°", "í”¼ë¶€ê°€ ê¿€í”¼ë¶€ âœ¨", "íƒë°°ê°€ ë¹¨ë¦¬ ì˜¨ë‹¤ ğŸ“¦", "ëŒ€ì¤‘êµí†µ íƒ€ì´ë° êµ¿ ğŸšŒ", "ìì‹ ê°ì„ ê°€ì ¸! ğŸ‘‘", "ì†Œí™•í–‰ì´ ì°¾ì•„ì˜¨ë‹¤ ğŸ¥°", "ë¨¸ë¦¬ ìŠ¤íƒ€ì¼ êµ¿ ğŸ’‡â€â™€ï¸", "ë§›ìˆëŠ” ë””ì €íŠ¸ ë°œê²¬ ğŸ°", "í•˜ëŠ˜ì„ ë´ë´ ì˜ˆë» â˜ï¸", "ì¢‹ì•„í•˜ëŠ” ë…¸ë˜ ë“¤ì–´ë´ ğŸ§", "ë¬¼ ë§ì´ ë§ˆì‹œê¸° ğŸ’§", "ìŠ¤íŠ¸ë ˆì¹­ ì«™ì«™ ğŸ§˜â€â™€ï¸", "ë°© ì²­ì†Œí•˜ë©´ ìš´ UP ğŸ§¹", "ì¼ì° ìë©´ í”¼ë¶€ ë¯¸ì¸ ğŸŒ™", "ìƒˆë¡œìš´ ì·¨ë¯¸ ë„ì „? ğŸ¨", "ì¹œêµ¬ì—ê²Œ í†¡í•´ë´ ğŸ“±", "í•‘í¬í…œì´ í–‰ìš´í…œ ğŸ€", "ë¹„íƒ€ë¯¼ ì±™ê²¨ ğŸ’Š", "ì°¨ í•œ ì”ì˜ ì—¬ìœ  â˜•", "ê·€ì—¬ìš´ ê³ ì–‘ì´ ë´„ ğŸ¾", "ì§€ê°‘ ì‚¬ìˆ˜! ğŸ’¸", "ìš°ì‚° ì±™ê²¨ â˜”", "ë§ ì¡°ì‹¬ ğŸ¤«", "ì €ì¥(Ctrl+S) í•„ìˆ˜ ğŸ’¾", "ë¬´ë¦¬ ê¸ˆì§€ ğŸ”‹", "ì²´í•¨ ì£¼ì˜ ğŸ¥„", "ë°œê°€ë½ ì°§ìŒ ì£¼ì˜ ğŸ¦¶", "ì§€ê° ì¡°ì‹¬ â°", "ë°°í„°ë¦¬ ì¶©ì „ âš¡", "ì§‘ì½•ì´ ìµœê³  ğŸ "],
            init: () => {
                const modal = document.createElement('div'); modal.className = 'custom-modal-overlay'; modal.onclick = () => modal.remove();
                modal.innerHTML = `<div class="flex flex-col items-center justify-center animate-pop-in" onclick="event.stopPropagation()"><div class="tarot-card" onclick="FortuneApp.flip(this)"><div class="tarot-inner"><div class="tarot-front"><div class="text-6xl mb-4">ğŸŒŸ</div><h3 class="text-xl font-bold text-pink-500 mb-2">Lucky!</h3><p class="text-sm text-gray-600 px-2 break-keep" id="fortune-text"></p></div><div class="tarot-back"></div></div></div><p class="text-white mt-4 font-bold text-shadow animate-pulse">ì¹´ë“œë¥¼ ëˆŒëŸ¬ì„œ ë’¤ì§‘ì–´ë³´ì„¸ìš”!</p></div>`;
                document.getElementById('modal-container').appendChild(modal);
            },
            flip: (el) => { if(el.classList.contains('flipped')) return; const randomFortune = FortuneApp.fortunes[Math.floor(Math.random() * FortuneApp.fortunes.length)]; document.getElementById('fortune-text').innerText = randomFortune; el.classList.add('flipped'); }
        };

        // Polaroid Widget (ìˆ˜ì •: ì§ì ‘ ì´ë¯¸ì§€ ë³€ê²½ ê¸°ëŠ¥ ë³µêµ¬)
        const PolaroidApp = {
            data: { caption: 'ìƒˆë´„ì´ ë•½', img: null },
            init: () => {
                const saved = DB.load('polaroid_data', PolaroidApp.data);
                PolaroidApp.data = { ...PolaroidApp.data, ...saved };
                PolaroidApp.render(); 
            },
            render: () => {
                const defaultImg = 'https://api.dicebear.com/7.x/avataaars/svg?seed=Saebom';
                const imgSrc = PolaroidApp.data.img || defaultImg;
                const el = document.getElementById('polaroid-widget');
                el.innerHTML = `
                    <div class="aspect-square bg-gray-200 mb-2 overflow-hidden border border-gray-100 group relative cursor-pointer" onclick="document.getElementById('polaroid-file-input').click()">
                        <img src="${imgSrc}" class="w-full h-full object-cover pointer-events-none">
                        <div class="polaroid-overlay text-white font-bold text-sm">ì‚¬ì§„ ë³€ê²½ ğŸ“·</div>
                    </div>
                    <input type="file" id="polaroid-file-input" class="hidden" accept="image/*" onchange="PolaroidApp.updateImage(this)">
                    <input class="polaroid-caption" value="${PolaroidApp.data.caption}" oninput="PolaroidApp.saveCaption(this.value)" placeholder="ë©”ëª¨..." onclick="event.stopPropagation()">
                `;
            },
            refresh: () => PolaroidApp.render(),
            saveCaption: (val) => { 
                PolaroidApp.data.caption = val; 
                DB.save('polaroid_data', PolaroidApp.data); 
            },
            updateImage: (input) => {
                if (input.files && input.files[0]) {
                    Utils.readFile(input.files[0], (dataUrl) => {
                        PolaroidApp.data.img = dataUrl;
                        DB.save('polaroid_data', PolaroidApp.data);
                        PolaroidApp.render();
                    });
                }
            }
        };

        // Time Capsule App
        const TimeCapsuleApp = {
            init: () => { TimeCapsuleApp.render(); },
            render: () => {
                const el = document.getElementById('app-time-capsule'); if(!el) return;
                let data = DB.load('time_capsule', null);
                let content = '';
                if (!data || !data.locked) {
                    const msg = data ? data.msg : ''; const date = data ? data.date : '';
                    content = `<div class="p-6 h-full flex flex-col gap-4 bg-pink-50/30"><h3 class="text-xl font-bold text-center text-orange-400">ğŸ“® ë¯¸ë˜ì˜ ë‚˜ì—ê²Œ</h3><textarea id="tc-msg" oninput="TimeCapsuleApp.saveDraft()" class="flex-1 p-4 rounded-xl border-2 border-orange-100 resize-none text-sm leading-relaxed outline-none focus:border-orange-300" placeholder="ë¯¸ë˜ì˜ ìƒˆë´„ì´ì—ê²Œ í¸ì§€ë¥¼ ì¨ë³´ì„¸ìš”...">${msg}</textarea><div class="flex items-center gap-2"><span class="text-xs text-gray-500">ê°œë´‰ì¼:</span><input id="tc-date" type="date" class="border rounded p-1 text-sm outline-none" value="${date}" onchange="TimeCapsuleApp.saveDraft()"></div><button onclick="TimeCapsuleApp.askLock()" class="w-full bg-orange-400 text-white py-2 rounded-xl font-bold hover:bg-orange-500 transition">íƒ€ì„ìº¡ìŠ ì ê·¸ê¸° ğŸ”’</button></div>`;
                } else {
                    const now = new Date().setHours(0,0,0,0); const unlock = new Date(data.date).setHours(0,0,0,0);
                    if (now >= unlock) {
                        content = `<div class="p-6 h-full flex flex-col gap-4 bg-yellow-50/50 items-center justify-center capsule-unlocked"><div class="text-6xl mb-4">ğŸ‰</div><h3 class="text-xl font-bold text-orange-500">íƒ€ì„ìº¡ìŠ ë„ì°©!</h3><div class="w-full flex-1 bg-white p-4 rounded-xl shadow-inner overflow-auto text-sm text-gray-700 whitespace-pre-wrap border border-orange-100">${data.msg}</div><p class="text-xs text-gray-400">${data.date}ì— ë´‰ì¸í•´ì œë¨</p><button onclick="TimeCapsuleApp.reset()" class="text-xs text-gray-400 underline mt-2">ìƒˆë¡œ ë§Œë“¤ê¸°</button></div>`;
                    } else {
                        const dDay = Math.ceil((unlock - now) / (1000 * 60 * 60 * 24));
                        content = `<div class="p-6 h-full flex flex-col items-center justify-center bg-gray-100"><div class="capsule-lock text-6xl mb-4">ğŸ”’</div><h3 class="text-lg font-bold text-gray-500">ë´‰ì¸ëœ íƒ€ì„ìº¡ìŠ</h3><p class="text-sm text-gray-400 mt-2">D-${dDay}ì¼ ë‚¨ìŒ</p><p class="text-xs text-gray-300 mt-1">${data.date}ì— ì—´ë¦½ë‹ˆë‹¤.</p></div>`;
                    }
                }
                el.innerHTML = content;
            },
            saveDraft: () => { const msg = document.getElementById('tc-msg').value; const date = document.getElementById('tc-date').value; DB.save('time_capsule', { msg, date, locked: false }); },
            askLock: () => {
                const msg = document.getElementById('tc-msg').value; const date = document.getElementById('tc-date').value;
                if(!msg.trim()) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); if(!date) return alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                const sel = new Date(date); sel.setHours(0,0,0,0); const now = new Date(); now.setHours(0,0,0,0);
                if(sel <= now) return alert('ë¯¸ë˜ì˜ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                const modal = document.createElement('div'); modal.className = 'custom-modal-overlay';
                modal.innerHTML = `<div class="custom-modal-box"><h3 class="text-lg font-bold mb-3 text-pink-500 text-center">ğŸ”’ ì •ë§ ì ê¸€ê¹Œìš”?</h3><p class="text-sm text-gray-600 text-center mb-4">${date}ê¹Œì§€ ì—´ì–´ë³¼ ìˆ˜ ì—†ì–´ìš”!<br>ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•´ì£¼ì„¸ìš”.</p><div class="flex justify-center gap-3"><button onclick="this.closest('.custom-modal-overlay').remove()" class="px-4 py-2 rounded text-gray-500 bg-gray-100">ì·¨ì†Œ</button><button onclick="TimeCapsuleApp.confirmLock()" class="px-4 py-2 rounded bg-orange-400 text-white font-bold">í™•ì¸</button></div></div>`;
                document.getElementById('modal-container').appendChild(modal);
            },
            confirmLock: () => { const msg = document.getElementById('tc-msg').value; const date = document.getElementById('tc-date').value; DB.save('time_capsule', { msg, date, locked: true }); document.querySelector('.custom-modal-overlay').remove(); TimeCapsuleApp.render(); },
            reset: () => { if(confirm('ìƒˆë¡œ ë§Œë“¤ê¹Œìš”?')) { DB.save('time_capsule', null); TimeCapsuleApp.render(); } }
        };

        // --- Editable Profile App (ìˆ˜ì •ë¨: í°ìƒ‰ ë°°ê²½) ---
        const ProfileApp = {
            data: {
                name: 'ìƒˆë´„', job: 'Web Designer', birth: '1996.11.04', mbti: 'ISFJ', live: 'Seoul', bf: ' ', fav: ' ', img: 'https://api.iconify.design/noto:rabbit-face.svg'
            },
            init: () => {
                const saved = DB.load('profile_data_v2', ProfileApp.data);
                ProfileApp.data = { ...ProfileApp.data, ...saved };
                const el = document.getElementById('app-profile');
                if(!el) return;
                
                // ë°°ê²½: ë‹¤ì‹œ í°ìƒ‰ìœ¼ë¡œ!
                el.innerHTML = `
                    <div class="flex flex-col items-center p-8 h-full overflow-y-auto custom-scrollbar bg-white">
                        
                        <!-- ì‚¬ì§„ ë³€ê²½ -->
                        <div class="relative w-40 h-40 mb-6 group cursor-pointer" onclick="document.getElementById('profile-file-input').click()">
                            <div class="w-full h-full rounded-full overflow-hidden border-[5px] border-pink-100 shadow-lg bg-pink-50 transition-transform transform group-hover:scale-105">
                                <img id="profile-img-display" src="${ProfileApp.data.img}" class="w-full h-full object-cover">
                            </div>
                            <div class="absolute inset-0 rounded-full flex items-center justify-center bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity text-white font-bold text-sm">
                                ì‚¬ì§„ ë³€ê²½ ğŸ“·
                            </div>
                        </div>
                        <input type="file" id="profile-file-input" class="hidden" accept="image/*" onchange="ProfileApp.updateImage(this)">

                        <!-- ì´ë¦„ & ì§ì—… (ìˆ˜ì • ê°€ëŠ¥) -->
                        <h1 class="text-3xl font-bold text-gray-800 mb-2 font-sans outline-none border-b border-transparent focus:border-pink-200" contenteditable="true" oninput="ProfileApp.save('name', this.innerText)">${ProfileApp.data.name}</h1>
                        <div class="text-pink-500 font-bold mb-8 uppercase tracking-widest bg-pink-50 px-3 py-1 rounded-full text-sm outline-none focus:ring-2 focus:ring-pink-300" contenteditable="true" oninput="ProfileApp.save('job', this.innerText)">${ProfileApp.data.job}</div>

                        <!-- ì •ë³´ ë¦¬ìŠ¤íŠ¸ (ìˆ˜ì • ê°€ëŠ¥) -->
                        <div class="w-full space-y-3 px-4">
                            ${ProfileApp.renderItem('BIRTH', 'birth')}
                            ${ProfileApp.renderItem('MBTI', 'mbti')}
                            ${ProfileApp.renderItem('LIVE', 'live')}
                            ${ProfileApp.renderItem('BF', 'bf')}
                            ${ProfileApp.renderItem('FAV', 'fav')}
                        </div>
                    </div>
                `;
            },
            renderItem: (label, key) => {
                return `
                    <div class="flex justify-between items-center border-b border-pink-50 pb-2 text-sm">
                        <span class="font-bold text-pink-400 w-16">${label}</span>
                        <span class="flex-1 text-right text-gray-600 font-medium outline-none border-b border-transparent focus:border-pink-200 transition-colors" contenteditable="true" oninput="ProfileApp.save('${key}', this.innerText)">${ProfileApp.data[key]}</span>
                    </div>
                `;
            },
            save: (key, val) => {
                ProfileApp.data[key] = val;
                DB.save('profile_data_v2', ProfileApp.data);
            },
            updateImage: (input) => {
                if (input.files && input.files[0]) {
                    Utils.readFile(input.files[0], (dataUrl) => {
                        ProfileApp.data.img = dataUrl;
                        document.getElementById('profile-img-display').src = dataUrl;
                        DB.save('profile_data_v2', ProfileApp.data);
                    });
                }
            }
        };

        // --- Diary Viewer ---
        const DiaryViewer = {
            date: new Date(), init: () => { DiaryViewer.render(); }, formatYMD: (y,m,d) => `${y}-${m}-${d}`, changeDate: (y, m) => { DiaryViewer.date.setFullYear(y); DiaryViewer.date.setMonth(m-1); DiaryViewer.render(); },
            render: () => {
                const el = document.getElementById('app-diary-viewer'); if(!el) return;
                const y = DiaryViewer.date.getFullYear(), m = DiaryViewer.date.getMonth();
                const diaries = DB.load('planner_diary_v2', {});
                
                // [NEW] ë¬´ë“œ í†µê³„ ê³„ì‚°
                const moodCounts = { 'ğŸ¥°': 0, 'ğŸ˜': 0, 'ğŸ˜­': 0, 'ğŸ˜¡': 0, 'ğŸ¥³': 0 };
                let totalDiaries = 0;
                const currentPrefix = `${y}-${m+1}-`;

                Object.keys(diaries).forEach(dateKey => {
                    // í•´ë‹¹ ë…„ì›”ì˜ ë°ì´í„°ì¸ì§€ í™•ì¸ (ì˜ˆ: 2025-12-XX)
                    const [dy, dm, dd] = dateKey.split('-').map(Number);
                    if (dy === y && dm === m + 1) {
                        const entry = diaries[dateKey];
                        if (entry.mood && moodCounts[entry.mood] !== undefined) {
                            moodCounts[entry.mood]++;
                            totalDiaries++;
                        }
                    }
                });

                let h = `<div class="flex flex-col h-full bg-white/50"><div class="flex justify-between items-center p-4 bg-white/50 border-b border-pink-100"><h2 class="text-xl font-bold text-pink-500 font-sans">ğŸ“– ê·¸ë¦¼ì¼ê¸° ëª¨ì•„ë³´ê¸°</h2><div class="flex gap-2"><select onchange="DiaryViewer.changeDate(this.value, ${m+1})" class="bg-white border-2 border-pink-100 rounded-lg px-2 py-1 text-sm text-gray-600 outline-none">${Array.from({length: 11}, (_, i) => y - 5 + i).map(yy => `<option value="${yy}" ${yy===y?'selected':''}>${yy}ë…„</option>`).join('')}</select><select onchange="DiaryViewer.changeDate(${y}, this.value)" class="bg-white border-2 border-pink-100 rounded-lg px-2 py-1 text-sm text-gray-600 outline-none">${Array.from({length: 12}, (_, i) => i + 1).map(mm => `<option value="${mm}" ${mm===m+1?'selected':''}>${mm}ì›”</option>`).join('')}</select></div></div><div class="photo-calendar-grid flex-1 overflow-auto">`;
                const first = new Date(y, m, 1).getDay(); const last = new Date(y, m + 1, 0).getDate();
                for(let i=0; i<first; i++) h += `<div></div>`;
                for(let i=1; i<=last; i++) {
                    const dateKey = DiaryViewer.formatYMD(y, m+1, i); const entry = diaries[dateKey];
                    let content = `<div class="no-img opacity-20"></div>`;
                    if (entry) { if (entry.img) content = `<img src="${entry.img}">`; else content = `<div class="no-img">ğŸ°</div>`; }
                    h += `<div class="photo-calendar-day" onclick="DiaryViewer.viewEntry('${dateKey}', ${i})"><span class="day-num">${i}</span>${content}</div>`;
                }
                h += `</div>`;

                // [NEW] ë¬´ë“œ ê·¸ë˜í”„ ì¶”ê°€ (ìŠ¬ë¦¼ ë²„ì „)
                h += `<div class="p-2 bg-white/80 border-t border-pink-100">
                        <h3 class="text-xs font-bold text-pink-500 mb-1 font-sans">ğŸ“Š ì´ë²ˆ ë‹¬ ë‚´ ê¸°ë¶„ì€?</h3>
                        <div class="space-y-1">`;
                
                for (const [mood, count] of Object.entries(moodCounts)) {
                    const percent = totalDiaries > 0 ? (count / totalDiaries) * 100 : 0;
                    const displayPercent = count > 0 ? Math.max(percent, 5) : 0; 
                    
                    h += `<div class="flex items-center gap-2 text-[10px]">
                            <span class="w-4 text-sm text-center">${mood}</span>
                            <div class="flex-1 h-1.5 bg-pink-50 rounded-full overflow-hidden border border-pink-100">
                                <div class="h-full bg-gradient-to-r from-pink-200 to-pink-400 transition-all duration-500 ease-out" style="width: ${displayPercent}%"></div>
                            </div>
                            <span class="w-6 text-gray-400 text-right font-bold">${count}</span>
                          </div>`;
                }
                h += `</div></div></div>`; // ë‹«ëŠ” íƒœê·¸ë“¤
                
                el.innerHTML = h;
            },
            viewEntry: (dateKey, day) => {
                const diaries = DB.load('planner_diary_v2', {}); const entry = diaries[dateKey]; if (!entry) return alert('ì´ ë‚ ì€ ì¼ê¸°ê°€ ì—†ì–´! ğŸ˜¢');
                const modal = document.createElement('div'); modal.className = 'custom-modal-overlay'; modal.onclick = () => modal.remove();
                modal.innerHTML = `<div class="custom-modal-box bg-white p-4 rounded-xl shadow-xl w-[400px]" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-3 border-b pb-2"><span class="font-bold text-pink-500 font-sans text-xl">${day}ì¼ì˜ ê·¸ë¦¼ì¼ê¸°</span><div class="flex gap-2 text-lg"><span>${entry.weather}</span><span>${entry.mood}</span></div></div><div class="w-full aspect-[4/3] bg-gray-50 rounded-lg overflow-hidden mb-3 border border-gray-100 flex items-center justify-center">${entry.img ? `<img src="${entry.img}" class="w-full h-full object-cover">` : '<span class="text-gray-300">ì‚¬ì§„ ì—†ìŒ</span>'}</div><div class="p-3 bg-pink-50/50 rounded-lg text-sm text-gray-700 min-h-[100px] whitespace-pre-wrap leading-relaxed font-sans text-lg">${entry.text || 'ë‚´ìš© ì—†ìŒ'}</div><div class="text-center mt-3"><button onclick="this.closest('.custom-modal-overlay').remove()" class="text-xs text-gray-400 underline">ë‹«ê¸°</button></div></div>`;
                document.getElementById('modal-container').appendChild(modal);
            }
        };

        const Planner = {
            date: new Date(), view: 'monthly', icons: ['ğŸ°', 'ğŸ¤', 'ğŸ’–', 'ğŸ€', 'ğŸ°', 'â­', 'ğŸŒ¸', 'ğŸ§¸', 'ğŸ­', 'ğŸµ'], weathers: ['â˜€ï¸', 'â˜ï¸', 'â˜”', 'â˜ƒï¸'], moods: ['ğŸ¥°', 'ğŸ˜', 'ğŸ˜­', 'ğŸ˜¡', 'ğŸ¥³'], selectedIcon: 'ğŸ°', currentDiary: { img: null, weather: 'â˜€ï¸', mood: 'ğŸ¥°' },
            init: () => { Planner.render(); }, formatYMD: (y,m,d) => `${y}-${m}-${d}`, formatMD: (m,d) => `${m}-${d}`, getWeekKey: (d) => { const onejan = new Date(d.getFullYear(), 0, 1); return `${d.getFullYear()}-W${Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7)}`; }, closePopup: (id) => { const el = document.getElementById(id); if (el) el.remove(); },
            render: () => {
                const el = document.getElementById('app-planner'); if(!el) return;
                const y = Planner.date.getFullYear(), m = Planner.date.getMonth();
                const diary = DB.load('planner_diary_v2', {}); const schedule = DB.load('planner_schedule', {}); const yearly = DB.load('planner_yearly', {}); const weekly = DB.load('planner_weekly_todo', {});
                let h = `<div class="flex flex-col h-full bg-white/50"><div class="flex gap-2 p-3 border-b shrink-0">${['monthly','weekly','yearly'].map(v => `<button onclick="Planner.view='${v}';Planner.render()" class="flex-1 py-2 rounded-lg text-sm font-bold capitalize transition ${Planner.view===v?'bg-pink-400 text-white shadow-md':'text-gray-400 hover:bg-pink-50'}">${v}</button>`).join('')}</div><div class="flex-1 overflow-hidden relative">`;
                if(Planner.view === 'monthly') {
                    h += `<div class="flex flex-col h-full"><div class="flex justify-between items-center p-4 bg-white/50"><div class="flex gap-2"><select onchange="Planner.changeDate(this.value, ${m+1})" class="bg-white border-2 border-pink-100 rounded-lg px-2 py-1 text-sm font-bold text-gray-700 outline-none hover:border-pink-300">${Array.from({length: 11}, (_, i) => y - 5 + i).map(yy => `<option value="${yy}" ${yy===y?'selected':''}>${yy}ë…„</option>`).join('')}</select><select onchange="Planner.changeDate(${y}, this.value)" class="bg-white border-2 border-pink-100 rounded-lg px-2 py-1 text-sm font-bold text-gray-700 outline-none hover:border-pink-300">${Array.from({length: 12}, (_, i) => i + 1).map(mm => `<option value="${mm}" ${mm===m+1?'selected':''}>${mm}ì›”</option>`).join('')}</select></div><button onclick="Planner.today()" class="bg-pink-400 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-sm hover:bg-pink-500 transition">ì˜¤ëŠ˜</button></div><div class="calendar-grid px-4 pb-2">${['SUN','MON','TUE','WED','THU','FRI','SAT'].map((d,i)=>`<div class="text-center text-[10px] font-bold ${i===0?'text-red-400':(i===6?'text-blue-400':'text-gray-400')}">${d}</div>`).join('')}</div><div class="calendar-grid flex-1 overflow-auto px-4 pb-4">`;
                    const first = new Date(y, m, 1).getDay(); const last = new Date(y, m + 1, 0).getDate(); for(let i=0; i<first; i++) h += `<div></div>`;
                    const now = new Date(); for(let i=1; i<=last; i++) {
                        const dateKey = Planner.formatYMD(y, m+1, i); const yearKey = Planner.formatMD(m+1, i); const isT = now.getFullYear()===y && now.getMonth()===m && now.getDate()===i; const anniv = yearly[yearKey]; const scheds = schedule[dateKey] || []; const hasDiary = diary[dateKey] ? true : false;
                        h += `<div onclick="Planner.openDatePopup(${y},${m},${i})" class="calendar-day ${isT?'today':''}"><div class="flex justify-between items-start"><span class="day-num text-sm font-bold ${isT?'':(new Date(y,m,i).getDay()===0?'text-red-500':(new Date(y,m,i).getDay()===6?'text-blue-500':'text-gray-700'))}">${i}</span>${hasDiary ? '<span class="text-sm">ğŸ°</span>' : ''}</div><div class="flex flex-col gap-0.5 mt-1 overflow-hidden">${anniv ? `<div class="schedule-item yearly">ğŸ‚ ${anniv}</div>` : ''}${scheds.map(s => `<div class="schedule-item monthly">${s}</div>`).join('')}</div></div>`;
                    } h += `</div></div>`;
                }
                else if(Planner.view === 'weekly') {
                    const curr = new Date(Planner.date); const day = curr.getDay(); const start = new Date(curr.setDate(curr.getDate() - day));
                    h += `<div class="flex flex-col h-full bg-pink-50/50 p-4 overflow-auto"><div class="flex justify-center items-center gap-4 mb-6"><button onclick="Planner.moveWeek(-7)"><i class="fas fa-chevron-left text-pink-300"></i></button><span class="text-lg font-bold text-pink-500 bg-white px-4 py-1 rounded-full shadow-sm border border-pink-100 font-sans">${start.getMonth()+1}ì›” ${Math.ceil(start.getDate()/7)}ì£¼ì°¨ Weekly</span><button onclick="Planner.moveWeek(7)"><i class="fas fa-chevron-right text-pink-300"></i></button><button onclick="Planner.thisWeek()" class="bg-pink-300 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-sm hover:bg-pink-400 absolute right-6">ì´ë²ˆ ì£¼</button></div><div class="grid grid-cols-1 gap-3">`;
                    const weekKey = Planner.getWeekKey(start); const weekData = weekly[weekKey] || {};
                    ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach((dname, idx) => {
                        const d = new Date(start); d.setDate(start.getDate() + idx); const isToday = new Date().toDateString() === d.toDateString(); const val = weekData[idx] || []; const todos = Array.isArray(val) ? val : [];
                        h += `<div class="flex flex-col bg-white rounded-xl shadow-sm border ${isToday?'border-pink-400 ring-1 ring-pink-200':'border-pink-50'} overflow-hidden min-h-[120px]"><div class="flex items-center justify-between bg-pink-50/50 px-3 py-2 border-b border-pink-100"><div class="flex items-center gap-2"><span class="text-xs font-bold ${idx===0?'text-red-400':(idx===6?'text-blue-400':'text-gray-500')}">${dname}</span><span class="text-lg font-bold text-gray-700">${d.getDate()}</span></div></div><div class="p-2 space-y-1 flex-1">${todos.map(t => `<div class="flex items-center gap-2 group hover:bg-pink-50/30 p-1 rounded transition"><input type="checkbox" ${t.done?'checked':''} onclick="Planner.toggleWeeklyTodo('${weekKey}', ${idx}, ${t.id})" class="accent-pink-400 cursor-pointer w-4 h-4 rounded-full border-pink-200"><span class="flex-1 text-sm ${t.done?'line-through text-gray-300':'text-gray-600'}">${t.text}</span><button onclick="Planner.deleteWeeklyTodo('${weekKey}', ${idx}, ${t.id})" class="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition px-1"><i class="fas fa-times"></i></button></div>`).join('')}${todos.length === 0 ? '<div class="text-xs text-gray-300 text-center py-2 italic">í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>' : ''}</div><div class="border-t border-pink-50 p-2 flex gap-1 bg-gray-50/30"><input type="text" class="flex-1 text-xs p-1.5 bg-white border border-pink-100 rounded focus:border-pink-300 outline-none" placeholder="í•  ì¼ ì…ë ¥..." onkeypress="if(event.key==='Enter') Planner.addWeeklyTodo('${weekKey}', ${idx}, this)"><button onclick="Planner.addWeeklyTodo('${weekKey}', ${idx}, this.previousElementSibling)" class="bg-pink-400 text-white px-2 rounded hover:bg-pink-500 text-xs"><i class="fas fa-plus"></i></button></div></div>`;
                    }); h += `</div></div>`;
                }
                else if(Planner.view === 'yearly') {
                    h += `<div class="flex flex-col h-full bg-pink-50/50 p-4 overflow-auto"><div class="flex justify-center items-center gap-4 mb-4"><button onclick="Planner.changeDate(${y-1}, 1)" class="text-gray-400"><i class="fas fa-chevron-left"></i></button><h2 class="text-2xl font-bold text-pink-500 font-sans">${y}ë…„ <span class="text-sm font-normal text-gray-500">(ê¸°ë…ì¼)</span></h2><button onclick="Planner.changeDate(${y+1}, 1)" class="text-gray-400"><i class="fas fa-chevron-right"></i></button></div><div class="grid grid-cols-3 gap-4">`;
                    for(let i=0; i<12; i++) { h += `<div class="yearly-month"><div class="text-center font-bold text-gray-700 mb-2 border-b border-pink-100 pb-1 font-sans text-lg">${i+1}ì›”</div><div class="yearly-grid">`; const last = new Date(y, i+1, 0).getDate(); const offset = new Date(y, i, 1).getDay(); for(let k=0; k<offset; k++) h+=`<div></div>`; for(let d=1; d<=last; d++) { const yKey = Planner.formatMD(i+1, d); const hasAnniv = yearly[yKey]; h += `<div onclick="Planner.openYearlyInput(${i+1}, ${d})" class="yearly-day ${hasAnniv?'has-anniversary':''}" title="${hasAnniv||''}">${d}</div>`; } h += `</div></div>`; } h += `</div><div class="text-center text-xs text-gray-400 mt-4">* ë‚ ì§œë¥¼ í´ë¦­í•˜ì—¬ ë§¤ë…„ ë°˜ë³µë˜ëŠ” ê¸°ë…ì¼ì„ ë“±ë¡í•˜ì„¸ìš”.</div></div>`;
                }
                h += `</div></div>`; el.innerHTML = h;
            },
            moveMonth: (d) => { Planner.date.setMonth(Planner.date.getMonth() + d); Planner.render(); },
            moveWeek: (d) => { Planner.date.setDate(Planner.date.getDate() + d); Planner.render(); },
            changeDate: (y, m) => { Planner.date.setFullYear(y); Planner.date.setMonth(m-1); Planner.render(); },
            today: () => { Planner.date = new Date(); Planner.view = 'monthly'; Planner.render(); },
            thisWeek: () => { Planner.date = new Date(); Planner.render(); },
            addWeeklyTodo: (wk, idx, el) => { const txt=typeof el==='string'?el:el.value; if(!txt.trim())return; const d=DB.load('planner_weekly_todo',{}); if(!d[wk])d[wk]={}; if(!d[wk][idx])d[wk][idx]=[]; d[wk][idx].push({id:Date.now(),text:txt,done:false}); DB.save('planner_weekly_todo',d); Planner.render(); },
            toggleWeeklyTodo: (wk, idx, id) => { const d=DB.load('planner_weekly_todo',{}); if(d[wk]&&d[wk][idx]){ const t=d[wk][idx].find(x=>x.id===id); if(t){t.done=!t.done; DB.save('planner_weekly_todo',d); Planner.render();} } },
            deleteWeeklyTodo: (wk, idx, id) => { const d=DB.load('planner_weekly_todo',{}); if(d[wk]&&d[wk][idx]){ d[wk][idx]=d[wk][idx].filter(x=>x.id!==id); DB.save('planner_weekly_todo',d); Planner.render(); } },
            openYearlyInput: (m, d) => { Planner.closePopup('input-modal'); const k=Planner.formatMD(m,d); const dta=DB.load('planner_yearly',{}); const c=dta[k]||''; const mDiv=document.createElement('div'); mDiv.id='input-modal'; mDiv.className='custom-modal-overlay'; mDiv.onmousedown=e=>e.stopPropagation(); mDiv.innerHTML=`<div class="custom-modal-box"><h3 class="text-lg font-bold mb-3 text-pink-600">ğŸ‚ ${m}ì›” ${d}ì¼ ê¸°ë…ì¼</h3><input id="modal-input" type="text" value="${c}" class="w-full border-2 border-pink-100 rounded p-2 mb-4 text-sm focus:border-pink-300 outline-none" placeholder="ë‚´ìš© ì…ë ¥..."><div class="flex justify-end gap-2"><button onclick="Planner.closePopup('input-modal')" class="px-3 py-1 rounded text-sm text-gray-500 hover:bg-gray-100">ì·¨ì†Œ</button><button onclick="Planner.saveYearly('${k}')" class="px-3 py-1 rounded text-sm bg-pink-400 text-white font-bold hover:bg-pink-500 shadow">ì €ì¥</button></div></div>`; document.getElementById('modal-container').appendChild(mDiv); document.getElementById('modal-input').focus(); },
            saveYearly: (k) => { const v=document.getElementById('modal-input').value; const d=DB.load('planner_yearly',{}); if(v)d[k]=v; else delete d[k]; DB.save('planner_yearly',d); Planner.closePopup('input-modal'); Planner.render(); },
            selectIcon: (ic) => { Planner.selectedIcon=ic; document.querySelectorAll('.icon-option').forEach(e=>e.classList.remove('selected')); Array.from(document.querySelectorAll('.icon-option')).find(e=>e.textContent===ic).classList.add('selected'); },
            openDatePopup: (y, m, d) => {
                Planner.closePopup('date-popup'); const dk=Planner.formatYMD(y,m+1,d); Planner.selectedIcon=Planner.icons[0];
                const md=document.createElement('div'); md.id='date-popup'; md.className='custom-modal-overlay'; md.onmousedown=e=>e.stopPropagation();
                md.innerHTML=`<div id="popup-content-box" class="bg-white rounded-2xl w-96 shadow-2xl overflow-hidden animate-pop-in border-2 border-pink-100"><div class="bg-pink-300 p-4 flex justify-between items-center text-white"><h3 class="font-bold text-lg font-sans">ğŸ€ ${m+1}ì›” ${d}ì¼</h3><button onclick="Planner.closePopup('date-popup')" class="hover:text-pink-100 text-xl"><i class="fas fa-times"></i></button></div><div id="view-schedule" class="p-4 flex flex-col gap-4"><div class="bg-pink-50/50 p-3 rounded-xl border border-pink-100"><h4 class="text-sm font-bold text-pink-500 mb-2">ğŸ“… í•‘í¬ ì¼ì • ì¶”ê°€</h4><div class="icon-selector" id="icon-container">${Planner.icons.map(ic=>`<div class="icon-option ${ic===Planner.icons[0]?'selected':''}" onclick="Planner.selectIcon('${ic}')">${ic}</div>`).join('')}</div><div class="flex gap-2"><input id="popup-schedule-input" class="flex-1 border border-pink-200 rounded px-2 py-1 text-sm outline-none focus:border-pink-400 bg-white" placeholder="ì¼ì • ì…ë ¥..." onkeypress="if(event.key==='Enter') document.getElementById('btn-add-sche').click()"><button id="btn-add-sche" class="bg-pink-400 text-white px-3 py-1 rounded text-xs hover:bg-pink-500 font-bold shadow-sm">ì¶”ê°€</button></div><ul id="popup-schedule-list" class="text-sm space-y-1 mt-3 max-h-24 overflow-auto custom-scrollbar"></ul></div><button onclick="Planner.switchView('diary', ${y}, ${m}, ${d})" class="w-full py-2 rounded-xl bg-purple-50 text-purple-500 font-bold hover:bg-purple-100 border border-purple-100 transition">ğŸ“ ê·¸ë¦¼ì¼ê¸° ì“°ëŸ¬ ê°€ê¸°</button></div><div id="view-diary" class="hidden p-0"></div></div>`;
                document.getElementById('modal-container').appendChild(md); Planner.renderScheduleList(dk);
                md.querySelector('#btn-add-sche').onclick=()=>{ const t=md.querySelector('#popup-schedule-input').value; if(t){ const s=DB.load('planner_schedule',{}); const l=s[dk]||[]; l.push(`${Planner.selectedIcon} ${t}`); s[dk]=l; DB.save('planner_schedule',s); md.querySelector('#popup-schedule-input').value=''; Planner.renderScheduleList(dk); Planner.render(); } };
            },
            renderScheduleList: (dk) => { const s=DB.load('planner_schedule',{}); const l=s[dk]||[]; const ul=document.getElementById('popup-schedule-list'); if(ul) ul.innerHTML=l.map((v,i)=>`<li class="flex justify-between items-center bg-white px-2 py-1 rounded border border-pink-100 mb-1 text-pink-600"><span>${v}</span><button onclick="Planner.removeSche('${dk}',${i})" class="text-red-300 hover:text-red-500"><i class="fas fa-times"></i></button></li>`).join(''); },
            removeSche: (dk, i) => { const s=DB.load('planner_schedule',{}); if(s[dk]){ s[dk].splice(i,1); DB.save('planner_schedule',s); Planner.renderScheduleList(dk); Planner.render(); } },
            switchView: (t,y,m,d) => {
                const b=document.getElementById('popup-content-box'), s=document.getElementById('view-schedule'), dv=document.getElementById('view-diary'), dk=Planner.formatYMD(y,m+1,d);
                if(t==='diary'){
                    b.classList.add('diary-modal'); s.classList.add('hidden'); dv.classList.remove('hidden');
                    const ds=DB.load('planner_diary_v2',{}); const e=ds[dk]||{img:null,weather:'â˜€ï¸',mood:'ğŸ¥°',text:''}; Planner.currentDiary=e;
                    dv.innerHTML=`<div class="p-4 flex flex-col gap-3 h-full"><div class="picture-frame" onclick="document.getElementById('diary-img-upload').click()">${e.img?`<img src="${e.img}">`:`<div class="text-center text-gray-400 text-sm"><i class="fas fa-camera text-2xl mb-1"></i><br>ì˜¤ëŠ˜ì˜ ì‚¬ì§„ì„<br>ë¶™ì—¬ì£¼ì„¸ìš”</div>`}</div><input type="file" id="diary-img-upload" class="hidden" accept="image/*" onchange="Planner.handleDiaryImage(this)"><div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg border border-gray-100"><div class="meta-selector">${Planner.weathers.map(w=>`<div class="meta-icon ${w===e.weather?'selected':''}" onclick="Planner.setMeta('weather','${w}')">${w}</div>`).join('')}</div><div class="w-px h-6 bg-gray-200"></div><div class="meta-selector">${Planner.moods.map(mo=>`<div class="meta-icon ${mo===e.mood?'selected':''}" onclick="Planner.setMeta('mood','${mo}')">${mo}</div>`).join('')}</div></div><textarea id="diary-text" class="lined-paper h-32 text-sm text-gray-700 font-sans text-lg" placeholder="ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?">${e.text||''}</textarea><div class="flex justify-between mt-2"><button onclick="Planner.switchView('schedule',${y},${m},${d})" class="text-gray-400 text-xs underline">ì¼ì •ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button><button onclick="Planner.saveDiary('${dk}')" class="bg-pink-400 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow-sm hover:bg-pink-500">ì €ì¥</button></div></div>`;
                } else { b.classList.remove('diary-modal'); s.classList.remove('hidden'); dv.classList.add('hidden'); }
            },
            handleDiaryImage: (ip) => { if(ip.files&&ip.files[0]) Utils.readFile(ip.files[0], b64=>{ Planner.currentDiary.img=b64; document.querySelector('.picture-frame').innerHTML=`<img src="${b64}">`; }); },
            setMeta: (type, val) => { Planner.currentDiary[type]=val; Array.from(document.querySelectorAll(`.meta-selector .meta-icon`)).filter(el=>(type==='weather'?Planner.weathers:Planner.moods).includes(el.innerText)).forEach(el=>{ if(el.innerText===val)el.classList.add('selected'); else el.classList.remove('selected'); }); },
            saveDiary: (dk) => { const txt=document.getElementById('diary-text').value; Planner.currentDiary.text=txt; const ds=DB.load('planner_diary_v2',{}); ds[dk]=Planner.currentDiary; DB.save('planner_diary_v2',ds); alert('ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆì–´! ğŸ’–'); Planner.render(); Planner.closePopup('date-popup'); }
        };

        // --- ê¸°íƒ€ ì•±ë“¤ ---
        const Apps = {
            notepad: { t: 'âœï¸ ë©”ëª¨ì¥', w: 400, h: 500, c: `<div id="app-notepad" class="h-full flex flex-col bg-pink-50/30"></div>`, run: () => Apps.notepad.run() },
            planner: { t: 'ğŸ“… ë‹¤ì´ì–´ë¦¬', w: 900, h: 700, c: `<div id="app-planner" class="h-full"></div>`, run: () => Planner.init() },
            todo: { t: 'âœ… íˆ¬ë‘ë¦¬ìŠ¤íŠ¸', w: 350, h: 500, c: `<div id="app-todo" class="h-full flex flex-col p-3 bg-white"></div>`, run: () => Apps.todo.run() },
            gallery: { t: 'ğŸ“· ê°¤ëŸ¬ë¦¬', w: 500, h: 600, c: `<div id="app-gallery" class="h-full flex flex-col"></div>`, run: () => Apps.gallery.run() },
            profile: { t: 'ğŸ° í”„ë¡œí•„', w: 380, h: 500, c: `<div id="app-profile" class="h-full overflow-hidden relative"></div>`, run: () => ProfileApp.init() },
            fortune: { t: 'ğŸ€ ì˜¤ëŠ˜ì˜ ìš´ì„¸', w: 400, h: 500, c: '', run: () => FortuneApp.init() }, 
            diary_viewer: { t: 'ğŸ“– ì¼ê¸° ëª¨ì•„ë³´ê¸°', w: 700, h: 600, c: `<div id="app-diary-viewer" class="h-full"></div>`, run: () => DiaryViewer.init() },
            time_capsule: { t: 'ğŸ“® íƒ€ì„ìº¡ìŠ', w: 400, h: 500, c: `<div id="app-time-capsule" class="h-full"></div>`, run: () => TimeCapsuleApp.init() },
            polaroid: { t: 'ğŸ“¸ í´ë¼ë¡œì´ë“œ', w: 0, h: 0, c:'', run: () => PolaroidApp.init() } 
        };
        
        Apps.notepad.run = () => { 
             const render = () => { const list = DB.load('memos', []); const el = document.getElementById('app-notepad'); if(!el) return; el.innerHTML = `<div class="p-3 bg-pink-100 flex justify-between"><span class="font-bold text-pink-600 font-sans text-lg">ëª©ë¡ (${list.length})</span><button onclick="Apps.notepad.add()" class="bg-white px-2 py-1 rounded text-xs shadow text-pink-500 hover:bg-pink-50"><i class="fas fa-plus"></i> ìƒˆ ë©”ëª¨</button></div><div class="flex-1 overflow-auto p-2 space-y-2">${list.map(m => `<div class="bg-white p-3 rounded shadow-sm cursor-pointer hover:bg-pink-50 border border-pink-50" onclick="Apps.notepad.edit(${m.id})"><div class="font-bold text-sm truncate text-gray-700">${m.t||'(ì œëª©ì—†ìŒ)'}</div><div class="text-xs text-gray-400 truncate">${m.c}</div></div>`).join('')}</div>`; };
             Apps.notepad.add = () => { const l=DB.load('memos',[]); l.unshift({id:Date.now(),t:'',c:''}); DB.save('memos',l); Apps.notepad.edit(l[0].id); };
             Apps.notepad.edit = (id) => { const l=DB.load('memos',[]); const m=l.find(x=>x.id===id); if(!m) return render(); document.getElementById('app-notepad').innerHTML = `<div class="h-full flex flex-col"><div class="p-2 bg-pink-100 flex justify-between"><button onclick="Apps.notepad.run()" class="text-pink-500 px-2"><i class="fas fa-arrow-left"></i> ëª©ë¡</button><div class="flex gap-2"><button onclick="Apps.notepad.del(${id})" class="text-red-400 px-2"><i class="fas fa-trash"></i></button><button onclick="Apps.notepad.save(${id})" class="bg-pink-400 text-white px-3 rounded text-xs font-bold">ì €ì¥</button></div></div><input id="note-t" class="p-3 bg-transparent font-bold border-b border-pink-200 outline-none text-gray-700 font-sans text-lg" value="${m.t}" placeholder="ì œëª©"><textarea id="note-c" class="flex-1 p-3 bg-transparent resize-none outline-none leading-relaxed text-gray-600 font-sans text-lg">${m.c}</textarea></div>`; };
             Apps.notepad.save = (id) => { const l=DB.load('memos',[]); const i=l.findIndex(x=>x.id===id); if(i>=0){ l[i].t=document.getElementById('note-t').value; l[i].c=document.getElementById('note-c').value; DB.save('memos',l); alert('ì €ì¥ë¨!'); Apps.notepad.run(); } };
             Apps.notepad.del = (id) => { if(confirm('ì‚­ì œí•´?')) { DB.save('memos', DB.load('memos',[]).filter(x=>x.id!==id)); Apps.notepad.run(); } }; render();
        };
        Apps.todo.run = () => {
             const render = () => { const l = DB.load('todos', []); document.getElementById('app-todo').innerHTML = `<div class="flex gap-2 mb-4"><input id="todo-in" class="flex-1 border-2 border-pink-100 rounded px-3 py-2 text-sm outline-none focus:border-pink-300 font-sans" placeholder="í•  ì¼..."><button onclick="Apps.todo.add()" class="bg-pink-400 text-white px-3 rounded hover:bg-pink-500"><i class="fas fa-plus"></i></button></div><div class="flex-1 overflow-auto space-y-2">${l.map(t=>`<div class="flex items-center gap-2 p-2 border border-pink-50 rounded hover:bg-pink-50"><input type="checkbox" ${t.d?'checked':''} onclick="Apps.todo.tog(${t.id})" class="accent-pink-400"><span class="flex-1 text-sm font-sans text-lg ${t.d?'line-through text-gray-400':''}">${t.t}</span><button onclick="Apps.todo.del(${t.id})" class="text-gray-300 hover:text-red-400"><i class="fas fa-times"></i></button></div>`).join('')}</div>`; };
             Apps.todo.add = () => { const v=document.getElementById('todo-in').value; if(v){ const l=DB.load('todos',[]); l.push({id:Date.now(),t:v,d:false}); DB.save('todos',l); render(); } };
             Apps.todo.tog = (id) => { const l=DB.load('todos',[]); const t=l.find(x=>x.id===id); if(t){ t.d=!t.d; DB.save('todos',l); render(); } };
             Apps.todo.del = (id) => { DB.save('todos',DB.load('todos',[]).filter(x=>x.id!==id)); render(); }; render();
        };
        Apps.gallery.run = () => {
             const render = () => { const l = DB.load('imgs', []); document.getElementById('app-gallery').innerHTML = `<div class="p-2 border-b border-pink-100 flex justify-between bg-white"><span class="text-xs text-gray-500">${l.length}ì¥</span><label class="cursor-pointer bg-pink-400 text-white px-3 py-1 rounded-lg text-xs hover:bg-pink-500 transition shadow-sm font-bold"><i class="fas fa-upload mr-1"></i> ì‚¬ì§„ ì¶”ê°€<input type="file" class="hidden" accept="image/*" onchange="Apps.gallery.up(this)"></label></div><div class="flex-1 overflow-auto grid grid-cols-2 gap-2 p-2 bg-pink-50">${l.length?l.map((s,i)=>`<div class="aspect-square bg-white border border-pink-100 rounded-xl overflow-hidden relative group"><img src="${s}" class="w-full h-full object-cover"><button onclick="Apps.gallery.del(${i})" class="absolute inset-0 bg-black/40 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center transition">ì‚­ì œ</button></div>`).join(''):'<div class="col-span-2 text-center py-10 text-gray-400 font-sans">ì‚¬ì§„ì„ ì˜¬ë ¤ì¤˜!</div>'}</div>`; };
             Apps.gallery.up = (el) => { if(el.files[0]) Utils.readFile(el.files[0], d => { const l=DB.load('imgs',[]); l.unshift(d); DB.save('imgs',l); render(); }); };
             Apps.gallery.del = (i) => { if(confirm('ì§€ì›Œ?')) { const l=DB.load('imgs',[]); l.splice(i,1); DB.save('imgs',l); render(); } }; render();
        };

        const app = {
            sky: null, wm: null,
            init: async () => {
                app.sky = new SkyRenderer(); 
                new MouseTrail(); 
                app.wm = new WindowManager(); 
                
                await DB.init();
                
                DDayApp.init(); 
                PolaroidApp.init(); 
                HeartWidget.init(); 
                RabbitPet.init();
                
                window.TimeCapsuleApp = TimeCapsuleApp; window.PolaroidApp = PolaroidApp; window.HeartWidget = HeartWidget; window.RabbitPet = RabbitPet; window.DDayApp = DDayApp; window.ProfileApp = ProfileApp;

                const update = () => { document.getElementById('clock-time').innerText = Utils.formatTime(); }; setInterval(update, 1000); update();
                fetch('https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current_weather=true').then(r=>r.json()).then(d=>{ document.getElementById('weather-text').innerText = `ë§‘ìŒ ${Math.round(d.current_weather.temperature)}Â°C`; }).catch(()=>{});
            },
            openWindow: (id) => { 
                if (id === 'fortune') { FortuneApp.init(); return; } 
                const a = Apps[id]; if(!a) return; 
                app.wm.create(id, a.t, a.c, a.w, a.h); 
                if(a.run) setTimeout(a.run, 0); 
            },
            close: (id) => app.wm.close(id), max: (id) => app.wm.max(id)
        };
        
        window.app = app; window.Planner = Planner; window.DDayApp = DDayApp; window.FortuneApp = FortuneApp; window.DiaryViewer = DiaryViewer; window.Apps = Apps; window.DB = DB; window.Utils = Utils; window.HeartWidget = HeartWidget; window.RabbitPet = RabbitPet; window.PolaroidApp = PolaroidApp; window.TimeCapsuleApp = TimeCapsuleApp; window.ProfileApp = ProfileApp;

        window.onload = app.init;
    </script>
</body>
</html>
